name: Security

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev]
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  security-events: write

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  bandit:
    name: Bandit Security Scan
    # Skip under act by default (can be overridden with workflow_dispatch)
    if: ${{ github.actor != 'nektos/act' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Run Bandit Security Analysis
        uses: PyCQA/bandit-action@v1
        with:
          # Configuration file path (severity/confidence settings)
          # NOTE: Baseline is NOT used - CI will always report ALL issues, not just new ones
          configfile: pyproject.toml
          # Explicit directories to scan (prefer explicit to avoid noise)
          targets: backend,scripts
          # Exclude directories (comma-separated)
          exclude: tests,.venv,venv,build,dist,.uvcache,__pycache__
          # Severity/confidence filters are in pyproject.toml
          # DO NOT set exit-zero - workflow must fail on issues
          # exit-zero: false  # This is the default, so we don't need to set it

    # Bandit findings are automatically published to GitHub Security tab
    # The workflow will fail if any issues are found (exit-zero not set)

  local_bandit:
    name: Local Bandit Scan (isolated env)
    # Run ONLY under local Act; never on GitHub
    if: ${{ github.actor == 'nektos/act' && github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: false # avoid deleting untracked files under act --bind
          fetch-depth: 0

      - name: Setup Python + uv (cached)
        uses: ./.github/actions/setup-uv

      - name: Sync dev dependencies
        run: |
          uv sync --group dev --frozen

      - name: Run Bandit scan (local)
        run: |
          uv run bandit -r -c pyproject.toml -x tests backend scripts

        # Local scan complete - results shown in workflow output
        # For production scans, check GitHub's Security tab

  detect-secrets:
    name: Detect Secrets Scan
    # Skip under act by default (can be overridden with workflow_dispatch)
    if: ${{ github.actor != 'nektos/act' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Python + uv (cached)
        uses: ./.github/actions/setup-uv

      - name: Sync dev dependencies
        run: |
          uv sync --group dev --frozen

      - name: Run detect-secrets scan
        run: |
          # Run detect-secrets via pre-commit to use the same configuration as local hooks
          # This will fail if new secrets are detected (not in baseline)
          uv run pre-commit run detect-secrets --all-files

        # detect-secrets will fail the workflow if new secrets are found
        # The baseline file (.secrets.baseline) must be kept in sync with the codebase
        # To update the baseline after adding legitimate secrets:
        #   1. Run locally: uv run pre-commit run detect-secrets --all-files
        #   2. If new secrets are found, audit them: detect-secrets audit .secrets.baseline
        #   3. Update baseline: detect-secrets scan --baseline .secrets.baseline
        #   4. Commit the updated .secrets.baseline file

  local_detect-secrets:
    name: Local Detect Secrets Scan (isolated env)
    # Run ONLY under local Act; never on GitHub
    if: ${{ github.actor == 'nektos/act' && github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          clean: false # avoid deleting untracked files under act --bind
          fetch-depth: 0

      - name: Setup Python + uv (cached)
        uses: ./.github/actions/setup-uv

      - name: Sync dev dependencies
        run: |
          uv sync --group dev --frozen

      - name: Run detect-secrets scan (local)
        run: |
          uv run pre-commit run detect-secrets --all-files

    # Local scan complete - results shown in workflow output
    # For production scans, check the workflow status

