#!/usr/bin/env bash
# .git/hooks/pre-commit - Run pre-commit framework with advanced options
set -Eeuo pipefail

# Source the shared config file
# shellcheck source=../scripts/common.sh
source "$(git rev-parse --show-toplevel)/scripts/common.sh"

# --- Start Logging ---
script_name="pre-commit"
LOG_FILE=$(init_script_logging "$script_name")
enable_error_trap "$LOG_FILE" "$script_name"
enable_debug_trace "$LOG_FILE"

# Duplicate all subsequent stdout/stderr to both console and log file without using tee
exec > >(while IFS= read -r line; do echo "$line"; echo "$line" >&3; done) 2>&1
# --- End Logging ---

# Ensure we are in the project root
cd "$(git rev-parse --show-toplevel)"

log INFO "â³ Running pre-commit framework with advanced checks..."

# Resolve pre-commit command (prefer project venv)
if [[ -x ".venv/bin/pre-commit" ]]; then
    PRE_COMMIT_CMD=".venv/bin/pre-commit"
elif command -v pre-commit >/dev/null 2>&1; then
    PRE_COMMIT_CMD="pre-commit"
else
    log ERROR "âŒ pre-commit not found. Install with: uv sync --group dev"
    log INFO "ğŸ’¡ Or run once via: uv run pre-commit run --all-files"
    exit 1
fi

# Run pre-commit on all files
# This will run: ruff (fix + format), yamlfmt, detect-secrets, and custom secrets scan
"$PRE_COMMIT_CMD" run --all-files 2>&1
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
    log ERROR "âŒ Pre-commit checks failed. Please fix the issues and try again."
    log INFO "ğŸ’¡ You can run individual hooks with: pre-commit run <hook-id>"
    log INFO "ğŸ’¡ Or run on specific files: pre-commit run --files <file1> <file2>"
    exit 1
fi

# Stage any files that were modified by the pre-commit hooks
log INFO "âœ“ Staging any files modified by pre-commit hooks..."
git add -u

log INFO "âœ… Pre-commit checks passed successfully."
log INFO "ğŸ‰ All checks completed: Ruff formatting, YAML formatting, and secrets scanning"
exit 0
